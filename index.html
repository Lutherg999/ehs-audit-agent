<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EHS Inspection App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212; /* dark background */
      color: #e8e6e3; /* light text */
      margin: 0;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #ffffff;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #1e1e1e; /* dark card */
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
      border: 1px solid #2a2a2a;
    }
    input, select, textarea {
      background-color: #262626;
      color: #f5f5f5;
      border: 1px solid #444;
    }
    input::placeholder, textarea::placeholder {
      color: #999;
    }
    select {
      color: #f5f5f5;
    }
    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      color: #fff;
      background-color: #0070f3;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #005bb5;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      color: #f5f5f5;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #333;
    }
    th {
      background-color: #2a2a2a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>EHS Inspection App</h1>
    <button id="startInspectionBtn" onclick="startInspection()" style="margin-bottom: 1rem;">
      Start Inspection
    </button>
    <p>
      Enter observation details below. The report will include the full
      context you provide here (section/location, question or hazard, answer,
      and a detailed description), along with a suggested corrective action. Use
      these suggestions as a starting point and adjust as necessary.
    </p>
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <input id="sectionInput" type="text" placeholder="Section/Location (e.g., Steel Receiving Yard)" style="padding:0.5rem; font-size:1rem; border: 1px solid #ccc; border-radius: 4px;" />
      <input id="questionInput" type="text" placeholder="Inspection question or hazard" style="padding:0.5rem; font-size:1rem; border: 1px solid #ccc; border-radius: 4px;" />
      <select id="answerInput" style="padding:0.5rem; font-size:1rem; border: 1px solid #ccc; border-radius: 4px;">
        <option value="">Answer...</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
        <option value="N/A">N/A</option>
      </select>
      <textarea id="descriptionInput" placeholder="Describe the observed condition or comments..." style="width:100%; height:80px; padding:0.5rem; font-size:1rem; border: 1px solid #ccc; border-radius: 4px;"></textarea>
      <button onclick="addObservation()">Add Observation</button>
    </div>
    <table id="observationsTable">
      <thead>
        <tr>
          <th>Section/Location</th>
          <th>Question/Hazard</th>
          <th>Answer</th>
          <th>Description</th>
          <th>Corrective Action (Suggested)</th>
        </tr>
      </thead>
      <tbody id="observationsBody"></tbody>
    </table>
    <button id="createReportButton" onclick="createReport()" disabled>
      Create Report
    </button>
    <pre id="reportOutput" style="white-space: pre-wrap; background: #1e1e1e; color: #e8e6e3; border: 1px solid #333; padding: 1rem; margin-top: 1rem; border-radius: 4px;"></pre>
    <hr style="margin: 2rem 0" />
    <h2 style="color: #ffffff;">Photo Inspection (Demo)</h2>
    <p>
      Upload a photo of the workspace to perform automated hazard detection. The
      app will send the image to a backend service at <code>/detect</code> and display
      the detected hazards as labeled bounding boxes. Ensure you have a
      server-side AI model running and listening on <code>/detect</code> that returns
      detections as an array of objects with <em>x</em>, <em>y</em>, <em>width</em>,
      <em>height</em>, <em>label</em>, and <em>score</em> properties.
    </p>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="runDetection()">Run Detection</button>
    <br />
    <canvas id="imageCanvas" style="margin-top: 1rem; max-width: 100%; border: 1px solid #444; background-color: #262626;"></canvas>
  </div>
  <script>
    // Simple heuristic-based action generator.
    function generateAction(observation) {
      const text = observation.toLowerCase();
      if (text.includes('filter') && text.includes('paint')) {
        return 'Replace missing paint booth filters and verify all filters are installed properly.';
      }
      if (text.includes('steel') && (text.includes('bollard') || text.includes('fabricated'))) {
        return 'Install additional bollards and schedule regular steel removal to avoid overcrowding.';
      }
      if (text.includes('band saw') || (text.includes('saw') && text.includes('guard'))) {
        return 'Do not use the saw until an appropriate blade guard is installed or repaired.';
      }
      if ((text.includes('face shield') || text.includes('eye protection')) && text.includes('wood saw')) {
        return 'Provide required face shield at the wood saw station and retrain operators on PPE.';
      }
      if (text.includes('stack') || text.includes('piles')) {
        return 'Re-stack material to maintain stable, safe piles and keep work areas clear.';
      }
      if (text.includes('transformer')) {
        return 'Keep the transformer area clear and maintain required clearance at all times.';
      }
      if (text.includes('exit') && text.includes('obstruct')) {
        return 'Remove the obstruction and ensure exit doors remain clear at all times.';
      }
      if (text.includes('exit sign') || (text.includes('exit') && text.includes('sign'))) {
        return 'Replace the broken exit sign and verify the illumination is functioning.';
      }
      if (text.includes('paint bucket') || (text.includes('paint') && text.includes('spill'))) {
        return 'Place paint buckets on approved spill pallets and provide additional pallets as needed.';
      }
      if (text.includes('bollard')) {
        return 'Install additional bollards as required to protect workers and equipment.';
      }
      // Default action
      return 'Evaluate the observation and determine appropriate corrective actions.';
    }

    function addObservation() {
      const sectionInput = document.getElementById('sectionInput');
      const questionInput = document.getElementById('questionInput');
      const answerInput = document.getElementById('answerInput');
      const descriptionInput = document.getElementById('descriptionInput');
      const section = sectionInput.value.trim();
      const question = questionInput.value.trim();
      const answer = answerInput.value;
      const description = descriptionInput.value.trim();
      // Require at least a question or description to be entered
      if (question === '' && description === '') {
        return;
      }
      // Generate action based on the concatenated question and description
      const combinedText = `${question} ${description}`.trim();
      const action = generateAction(combinedText);
      const tbody = document.getElementById('observationsBody');
      const row = document.createElement('tr');
      // Create cells in the order defined in the table header
      const sectionCell = document.createElement('td');
      const questionCell = document.createElement('td');
      const answerCell = document.createElement('td');
      const descriptionCell = document.createElement('td');
      const actionCell = document.createElement('td');
      sectionCell.textContent = section;
      questionCell.textContent = question;
      answerCell.textContent = answer;
      descriptionCell.textContent = description;
      actionCell.textContent = action;
      row.appendChild(sectionCell);
      row.appendChild(questionCell);
      row.appendChild(answerCell);
      row.appendChild(descriptionCell);
      row.appendChild(actionCell);
      tbody.appendChild(row);
      // Add to current inspection data
      inspectionData.observations.push({
        section: section,
        question: question,
        answer: answer,
        description: description,
        action: action,
      });
      // Enable report generation
      document.getElementById('createReportButton').disabled = false;
      // Clear input fields for next entry
      sectionInput.value = '';
      questionInput.value = '';
      answerInput.value = '';
      descriptionInput.value = '';
    }

    // === Inspection session and report ===
    // Holds current inspection metadata and observations
    let inspectionData = {
      site: '',
      date: '',
      observations: [],
    };

    function startInspection() {
      const site = prompt('Enter the inspection site/location:');
      if (site === null || site.trim() === '') {
        return;
      }
      inspectionData.site = site.trim();
      inspectionData.date = new Date().toLocaleString();
      inspectionData.observations = [];
      // Clear previous observations and report
      document.getElementById('observationsBody').innerHTML = '';
      document.getElementById('reportOutput').textContent = '';
      document.getElementById('createReportButton').disabled = true;
      // Clear the observation entry fields
      document.getElementById('sectionInput').value = '';
      document.getElementById('questionInput').value = '';
      document.getElementById('answerInput').value = '';
      document.getElementById('descriptionInput').value = '';
    }

    function createReport() {
      if (inspectionData.observations.length === 0) {
        alert('No observations recorded.');
        return;
      }
      const lines = [];
      lines.push(`Inspection report for: ${inspectionData.site}`);
      lines.push(`Date: ${inspectionData.date}`);
      lines.push('');
      inspectionData.observations.forEach((item, idx) => {
        lines.push(`${idx + 1}. Section/Location: ${item.section || 'N/A'}`);
        lines.push(`   Question/Hazard: ${item.question || 'N/A'}`);
        lines.push(`   Answer: ${item.answer || 'N/A'}`);
        lines.push(`   Description: ${item.description || 'N/A'}`);
        lines.push(`   Suggested Corrective Action: ${item.action}`);
        lines.push('');
      });
      const reportText = lines.join('\n');
      // Display the report
      document.getElementById('reportOutput').textContent = reportText;
      // Optionally create a downloadable text file
      const blob = new Blob([reportText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      // Create a temporary download link
      const link = document.createElement('a');
      link.href = url;
      link.download = `inspection-report-${Date.now()}.txt`;
      link.textContent = 'Download Report';
      // Remove existing download links
      const existingLinks = document.querySelectorAll('#reportOutput a');
      existingLinks.forEach((l) => l.remove());
      // Append new download link
      document.getElementById('reportOutput').appendChild(document.createElement('br'));
      document.getElementById('reportOutput').appendChild(link);
    }

    // === Photo Inspection (Demo) ===
    let uploadedImage = new Image();

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        uploadedImage.onload = function () {
          // Draw the image without boxes initially
          drawImageAndBoxes([]);
        };
        uploadedImage.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function drawImageAndBoxes(boxes) {
      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      // Resize canvas to image dimensions
      canvas.width = uploadedImage.width;
      canvas.height = uploadedImage.height;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(uploadedImage, 0, 0);
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'red';
      ctx.fillStyle = 'red';
      ctx.font = '16px Arial';
      boxes.forEach((box) => {
        const { x, y, width, height, label } = box;
        ctx.strokeRect(x, y, width, height);
        // Position label above the rectangle if possible
        const labelX = x;
        const labelY = y > 20 ? y - 5 : y + 15;
        ctx.fillText(label, labelX, labelY);
      });
    }

    async function runDetection() {
      // Ensure an image is uploaded
      const fileInput = document.getElementById('imageInput');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please upload an image first.');
        return;
      }
      // Prepare form data
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      try {
        // Show a temporary message while detection is processing
        drawImageAndBoxes([]);
        const ctx = document.getElementById('imageCanvas').getContext('2d');
        ctx.font = '18px Arial';
        ctx.fillStyle = '#00aaff';
        ctx.fillText('Running detection...', 10, 25);
        // Send the image to the detection endpoint
        const response = await fetch('/detect', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          throw new Error('Detection API request failed');
        }
        const detections = await response.json();
        // Expect detections as an array of { x, y, width, height, label, score }
        drawImageAndBoxes(detections);
      } catch (error) {
        console.error(error);
        alert('Detection failed. Ensure the backend detection service is running.');
      }
    }

    // Attach change event
    document.getElementById('imageInput').addEventListener('change', handleImageUpload);
  </script>
</body>
</html>
